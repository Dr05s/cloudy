name: Build Kernel

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release Tag'
        required: true
        default: v1.0.0
      kernel:
        description: 'Kernel Repo URL'
        require: true
      gcc:
        description: 'GCC Download URL'
        require: true
      compression:
        description: 'GCC Compression type'
        require: true
        type: choice
        default: "zip"
        options:
          - zip
          - tar.gz
          - tar.xz
      config:
        description: 'Defconfig Filename'
        require: true
      build:
        description: "Build type"
        required: true
        type: choice
        default: "NonKSU"
        options:
          - NonKSU
          - KSU
      susfs:
        description: 'Using SUSFS?'
        require: true
        type: choice
        default: "No"
        options:
          - No
          - Yes
    push:
      branches: 
        - main
    pull_request_target:
      branches: 
        - main

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Set ENV
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "CC=$(pwd)/clang/bin/clang" >> $GITHUB_ENV
          echo "CLANG_TRIPLE=$(pwd)/gcc/bin/aarch64-linux-gnu-" >> $GITHUB_ENV
      - name: Clone Kernel Repo
        run: |
          git clone ${{ inputs.kernel }} kernel_dir
          rm -rf .git
          rm -rf .github
          if [ -d kernel_dir/ksu/ ]; then
            rm -rf ksu
          fi
          mv kernel_dir/* ./
      - name: Init submodules
        if: inputs.build == 'KSU'
        run: git submodule update --init --recursive
      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq --no-install-recommends \
            git build-essential bc bison flex \
            libssl-dev libelf-dev zlib1g-dev \
            clang lld llvm gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
            python3 python3-pip ninja-build zip
          sudo ln -sf /usr/bin/ld.lld /usr/bin/ld || true
          chmod +x prepare_compiler.sh
          chmod +x clang.sh
          ./prepare_compiler.sh ${{ inputs.gcc }} ${{ inputs.compression }}
      - name: Build NonKSU kernel and log output
        if: inputs.build == 'NonKSU'
        run: |
          mkdir -p out
          make O=out ARCH=$ARCH CC=$CC ${{ inputs.config }}
          cp -af out/.config out/output_config
          ./clang.sh | tee build.log
      - name: Apply SUSFS patch
        if: inputs.build == 'KSU' && inputs.susfs == 'Yes'
        run: |
          cd KernelSU
          patch -p1 < ksu/patches/0000-enable-susfs-for-ksu.patch
      - name: Build KSU kernel and log output
        if: inputs.build == 'KSU'
        run: |
          mkdir -p out
          make O=out ARCH=$ARCH CC=$CC ${{ inputs.config }}
          cp -af out/.config out/output_config
          chmod +x ksu/applyPatches.sh
          ./ksu/applyPatches.sh
          ./clang.sh | tee build.log
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel
          path: |
            out/arch/arm64/boot/Image.gz
            out/arch/arm64/boot/dts/
            out/output_config
            build.log